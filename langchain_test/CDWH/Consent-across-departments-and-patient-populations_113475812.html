<!DOCTYPE html>
<html>
    <head>
        <title>DataWarehouse : Consent across departments and patient populations</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">DataWarehouse</a></span>
                            </li>
                                                    <li>
                                <span><a href="DataWarehouse_33423377.html">DataWarehouse</a></span>
                            </li>
                                                    <li>
                                <span><a href="FAQ-CDWH-Analysis_33424229.html">FAQ CDWH Analysis</a></span>
                            </li>
                                                    <li>
                                <span><a href="257425449.html">Research consent / Forschungskonsent</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            DataWarehouse : Consent across departments and patient populations
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Nicole Goebel</span>, last modified on Jan. 19, 2023
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>This example is intended to illustrate that Consent is not requested with the same frequency in all divisions. It involves ticket 20221214-3251 with the following query:</p><p>Population A:</p><ul><li><p>≥ 18 years</p></li><li><p>AND community-acquired pneumonia (ICD-10: J13, J14, J15, J18.0, J18.1, J18.8).</p></li><li><p>AND negative urinary Legionella antigen.</p></li><li><p>inpatient, 2020-21</p></li></ul><p>Population B:</p><ul><li><p>≥ 18 years</p></li><li><p>AND confirmed COVID-19 (ICD-10: U07.1)</p></li><li><p>inpatient, 2020-21</p></li></ul><p>The corresponding SQL query is:</p><div class="table-wrap"><table data-layout="default" data-local-id="5aec62c2-95b2-4486-8907-a754a99ec083" class="confluenceTable"><colgroup><col style="width: 680.0px;"/></colgroup><tbody><tr><td class="confluenceTd"><p>--------------------------------------------------------------------------------Bausteine Population A<br/>--------------------------------------------------------------------------------Summieren <br/>(<br/>SELECT count(*) AS Anz_Pat<br/> , CON_VALUE, POPULATION, CAS_YEAR<br/>FROM <br/>(<br/>---------------------------------------- WITH 1: Consent<br/>WITH CONSENT AS (<br/>SELECT * FROM (<br/> SELECT *, CAST(ROW_NUMBER() OVER (PARTITION BY PAT_BK ORDER BY CON_VALID_FROM_DATE DESC, CON_VALID_TO_DATE DESC) AS SMALLINT) AS sorter<br/> FROM cdwh.v_il_dim_consent_CUR<br/> WHERE 1=1<br/>  AND CON_TYPE_NK = 'Allgemeiner Forschungsconsent'<br/>  AND CON_IS_ACTIVE = 1<br/>  AND DWH_IS_DELETED &lt;&gt; 1<br/>  AND CURRENT_DATE &lt; CON_VALID_TO_DATE<br/> )<br/>WHERE SORTER = 1<br/>)<br/>---------------------------------------- WITH 2: Age &gt;= 18 years<br/>,PAT_CAS AS (<br/>SELECT <br/> p.PAT_BK, p.PAT_GENDER, c.CAS_BK, p.PAT_BIRTH_DATE, c.CAS_START_DATE_TS, years_between(p.PAT_BIRTH_DATE,c.CAS_START_DATE_TS) AS CASE_AGE, p.PAT_DEATH<br/>FROM CDWH.V_IL_DIM_CASE_CUR  AS c<br/>JOIN  CDWH.V_IL_DIM_PATIENT_CID AS p<br/>ON p.PAT_BK = c.PAT_BK<br/>WHERE 1=1<br/> AND years_between(p.PAT_BIRTH_DATE,c.CAS_START_DATE_TS) &gt;= 18<br/> AND p.PAT_BIRTH_DATE &lt;&gt; '1900-01-01'<br/> AND c.CAS_TYPE = 'stationär'<br/> AND CAS_CANCELLATION_FLAG &lt;&gt; 1<br/> AND CAS_START_DATE_TS &lt; now() --NOT LIKE '9999%'<br/>ORDER BY CASE_AGE DESC <br/>)<br/>---------------------------------------- WITH 3: UND ambulant erworbene Pneumonie (ICD-10: J13, J14, J15, J18.0, J18.1, J18.8)<br/>,PNEUMO AS (<br/>SELECT *<br/>FROM CDWH.V_IL_FCT_DIAGNOSIS  --Nicht _ISMED, weil unvollständig: ;SELECT * FROM CDWH.V_IL_FCT_DIAGNOSIS_ISMED WHERE DII_DIAG_ICD_ID &lt;&gt;'-1'<br/>WHERE 1=1<br/> AND DiG_storno_flag=0<br/> AND (1 = 0<br/> OR dia_nk LIKE 'J13%'  --LIKE '%' statt =, damit alle J13 angezeigt werden!<br/> OR dia_nk LIKE 'J14%'<br/> OR dia_nk LIKE 'J15%'<br/> OR dia_nk LIKE 'J18.0%'<br/> OR dia_nk LIKE 'J18.1%'<br/> OR dia_nk LIKE 'J18.8%')<br/>)<br/>---------------------------------------- WITH 4: UND negatives Legionellen-Antigen im Urin<br/>,LEGION_NEG AS (<br/>SELECT cas_bk, pat_bk<br/>  , sum(leg_pos) AS ANZ_POS --summiere LEG_POS<br/>  , sum(leg_neg) AS ANZ_neg<br/> FROM <br/>  (SELECT a.PAT_BK<br/>   , a.CAS_BK<br/>   , IFNULL(LSM_SAMPLE_TAKEN_DATE_TS, LSM_SAMPLE_ENTRY_DATE_TS) AS PROBEN_ZEITPUNKT<br/>   , a.LPM_BK, d.lpm, a.LPTM_BK, e.lptm, LPRM_RESULT<br/>   , CASE WHEN a.LPTM_BK IN ( 'lagp' , 'lagsp' , 'nvleag') then 1 else 0 END AS LEG_POS --Positiv: SELECT lptm_bk, lptm from cdwh.V_IL_DIM_LABOR_PROCEDURE_RESULT_TEXT_MLAB_CID vidlprtmc WHERE lPTM_BK IN ('knleag' , 'nvleag' , 'lagn' , 'lagp' , 'lagsn' , 'lagsp')<br/>   , CASE WHEN a.LPTM_BK IN ( 'knleag' , 'lagn' , 'lagsn') then 1 else 0 END AS LEG_NEG  --Negativ<br/>  FROM cdwh.V_IL_FCT_LABOR_PROCEDURE_RESULT_MLAB   AS a<br/>  JOIN  cdwh.V_IL_DIM_LABOR_SAMPLE_MLAB_CID    AS b <br/>  ON  a.lsm_bk = b.LSM_BK<br/>   AND b.LSM_MATERIAL_ID IN ('um' , 'u' , 'ub' , 'ud' , 'ue' , 'uro' , 'unb' , 'usk')  --Urin; dieses AND könnte auch unten ins WHERE, passt inhaltlich aber hierhin.<br/>  JOIN  cdwh.V_IL_DIM_LABOR_PROCEDURE_MLAB_CID    AS d <br/>  ON a.lpm_bk = d.lpm_bk<br/>  JOIN  cdwh.V_IL_DIM_LABOR_PROCEDURE_RESULT_TEXT_MLAB_CID  AS e <br/>  ON a.LPTM_BK = e.lptm_bk<br/>  WHERE 1=0<br/>   OR a.LPM_BK IN ('lag' , 'lags')<br/>   OR a.LPTM_BK IN ('knleag' , 'nvleag' , 'lagn' , 'lagp' , 'lagsn' , 'lagsp')<br/>  ORDER BY<br/>   PAT_BK, CAS_BK<br/>   , IFNULL(LSM_SAMPLE_TAKEN_DATE_TS, LSM_SAMPLE_ENTRY_DATE_TS)<br/>   )<br/> GROUP BY<br/>  cas_bk, pat_bk<br/> HAVING 1=1<br/>  AND sum(leg_pos) = 0 --Negativ bedeutet in der Regel: Mindestens 1 negativ und 0 positiv, weil oft mehrfach getestet.<br/>  AND sum(leg_neg)&gt;= 1 --17.387 (vs 17.581)<br/>)<br/>---------------------------------------- SELECT: Auszählung / count() --/Jahr, #Fälle, #Patienten<br/>SELECT<br/> DISTINCT CAS.PAT_BK<br/> , EXTRACT (YEAR FROM CAS_START_DATE_TS) AS CAS_YEAR<br/> , CON_VALUE<br/>-- , CON_GENERAL_DENIAL<br/> , 'Pneumonie_ohne_Legionellen' AS Population<br/>FROM PAT_CAS AS CAS<br/>LEFT JOIN CONSENT  AS CON --Ohne LEFT JOIN haut es mir Leute raus!<br/>ON CAS.PAT_BK = CON.PAT_BK<br/>JOIN  PNEUMO  AS PNE<br/>ON  CAS.CAS_BK = PNE.CAS_BK<br/>JOIN  LEGION_NEG  AS LEG<br/>ON  CAS.CAS_BK = LEG.CAS_BK <br/>ORDER BY CAS_YEAR ASC    --Erster Fall im 2011<br/>--------------------------------------------------------------------------------Summieren <br/>)<br/>GROUP BY CON_VALUE, POPULATION, CAS_YEAR<br/>HAVING CAS_YEAR BETWEEN '2020' AND '2021'<br/>ORDER BY CAS_YEAR<br/>--------------------------------------------------------------------------------Bausteine Population B<br/>)<br/>UNION<br/>(<br/>--------------------------------------------------------------------------------Summieren <br/>SELECT count(*) AS Anz_Pat<br/> , CON_VALUE, POPULATION, CAS_YEAR<br/>FROM <br/>(<br/>---------------------------------------- WITH 1: Consent<br/>WITH CONSENT AS (<br/>SELECT * FROM (<br/> SELECT *, CAST(ROW_NUMBER() OVER (PARTITION BY PAT_BK ORDER BY CON_VALID_FROM_DATE DESC, CON_VALID_TO_DATE DESC) AS SMALLINT) AS sorter<br/> FROM cdwh.v_il_dim_consent_cid<br/> WHERE 1=1<br/>  AND CON_TYPE_NK = 'Allgemeiner Forschungsconsent'<br/>  AND CON_IS_ACTIVE = 1<br/>  AND DWH_IS_DELETED &lt;&gt; 1<br/>  AND CURRENT_DATE &lt; CON_VALID_TO_DATE<br/> )<br/>WHERE SORTER = 1<br/>)<br/>---------------------------------------- WITH 2: Age &gt;= 18 years<br/>,PAT_CAS AS (<br/>SELECT <br/> p.PAT_BK, p.PAT_GENDER, c.CAS_BK, p.PAT_BIRTH_DATE, c.CAS_START_DATE_TS, years_between(p.PAT_BIRTH_DATE,c.CAS_START_DATE_TS) AS CASE_AGE, p.PAT_DEATH<br/>FROM CDWH.V_IL_DIM_CASE_CUR  AS c<br/>JOIN  CDWH.V_IL_DIM_PATIENT_CID AS p<br/>ON p.PAT_BK = c.PAT_BK<br/>WHERE 1=1<br/> AND years_between(p.PAT_BIRTH_DATE,c.CAS_START_DATE_TS) &gt;= 18<br/> AND p.PAT_BIRTH_DATE &lt;&gt; '1900-01-01'<br/> AND c.CAS_TYPE = 'stationär'<br/> AND CAS_CANCELLATION_FLAG &lt;&gt; 1<br/> AND CAS_START_DATE_TS &lt; now() --NOT LIKE '9999%'<br/>ORDER BY CASE_AGE DESC <br/>)<br/>---------------------------------------- WITH 3: confirmed COVID-19<br/>,COVID_LAB AS ( <br/>SELECT *<br/>FROM  cdwh.V_IL_FCT_LABOR_RESULT_XLAB   AS res<br/>--JOIN  cdwh.V_IL_DIM_CASE_CID    AS cas<br/>--ON  res.CAS_BK = cas.CAS_BK    -- !!! res.PAT_BK = cas.PAT_BK führt zu falschem Ergebnis!<br/>--JOIN cdwh.V_IL_DIM_LABOR_METHOD_XLAB_CID  AS met<br/>--ON res.LMX_BK = met.LMX_BK<br/>WHERE  1=1<br/> --AND cas.CAS_START_DATE_TS BETWEEN '2021-06-01 00:00:00.000' AND '2022-01-01 00:00:00.000' -- lieber Falldatum als Resultatdatum<br/> --AND met.LMX_METHOD LIKE '%SARS%'          -- zu unspezifisch<br/> AND res.LMX_METHOD_SHORT_NAME IN ('M-AB-SARSCoV2-01','M-AB-SARSCoV2Cob-01','M-AB-SARSCoV2QN-01','M-SK-SARSCoV2-01','M-SK-SARSCoV2QN-01','M-AB-SARSCoV2Xprt-01','M-AB-SARSCoV2Biof-01')<br/> AND (lower(res.LRX_RESULT_VALUE) LIKE '%pos%'<br/>  OR (res.LRX_RESULT_VALUE_NUMERIC IS NOT NULL<br/>   AND LRX_RESULT_VALUE_COMPARATOR='='))<br/>)<br/>---------------------------------------- WITH 3: confirmed COVID-19 ALTERNATIVE<br/>,COVID_ICD AS (<br/>SELECT * <br/>FROM CDWH.V_IL_FCT_DIAGNOSIS  --Nicht _ISMED, weil unvollständig: ;SELECT * FROM CDWH.V_IL_FCT_DIAGNOSIS_ISMED WHERE DII_DIAG_ICD_ID &lt;&gt;'-1'<br/>WHERE 1=1<br/> AND dia_nk LIKE 'U07.1%'<br/> AND DiG_storno_flag=0<br/>)<br/>---------------------------------------- SELECT: Auszählung / count() --/Jahr, #Fälle, #Patienten<br/>SELECT <br/>-- DISTINCT CAS.CAS_BK<br/> DISTINCT CAS.PAT_BK <br/> , EXTRACT (YEAR FROM CAS_START_DATE_TS) AS CAS_YEAR<br/> , CON_VALUE<br/>-- , CON_GENERAL_DENIAL  --Wenn ja, dann Patient nie wieder fragen. Für unsere Queries idR nicht relevant.<br/> , 'COVID' AS Population<br/>FROM PAT_CAS  AS CAS --173’096 DISTINCT PAT_BK<br/>LEFT JOIN CONSENT AS CON --173’096 DISTINCT PAT_BK; Ohne LEFT JOIN haut es mir Leute raus!<br/>ON CAS.PAT_BK = CON.PAT_BK<br/>--JOIN  COVID_LAB AS COV<br/>--ON  CAS.CAS_BK = COV.CAS_BK --&gt;  2’626 DISTINCT PAT_BK; 2’727 DISTINCT CAS_BK; 35’033 mit allen CAS_TYPE (inkl. amb) <br/>JOIN  COVID_ICD AS COV<br/>ON  CAS.CAS_BK = COV.CAS_BK --&gt;  3.497 DISTINCT PAT_BK; 3.625 DISTINCT CAS_BK; 3.629 mit allen CAS_TYPE (inkl. amb)<br/>ORDER BY CAS_YEAR ASC   --Erster Fall am 11.02.2020<br/>--------------------------------------------------------------------------------Summieren <br/>)<br/>GROUP BY CON_VALUE, POPULATION, CAS_YEAR<br/>HAVING CAS_YEAR BETWEEN '2020' AND '2021'<br/>ORDER BY CAS_YEAR<br/>)</p></td></tr></tbody></table></div><p>The result is a typical frequency table:</p><div class="table-wrap"><table data-layout="default" data-local-id="82d47843-37d6-4f33-a783-d22e724801ed" class="confluenceTable"><colgroup><col style="width: 133.0px;"/><col style="width: 145.0px;"/><col style="width: 380.0px;"/><col style="width: 98.0px;"/></colgroup><tbody><tr><td class="confluenceTd"><p><strong>ANZ_PAT</strong></p></td><td class="confluenceTd"><p><strong>CONSENT</strong></p></td><td class="confluenceTd"><p><strong>POPULATION</strong></p></td><td class="confluenceTd"><p><strong>JAHR</strong></p></td></tr><tr><td class="confluenceTd"><p>425</p></td><td class="confluenceTd"><p>Ja</p></td><td class="confluenceTd"><p>COVID</p></td><td class="confluenceTd"><p>2020</p></td></tr><tr><td class="confluenceTd"><p>299</p></td><td class="confluenceTd"><p>n.a.</p></td><td class="confluenceTd"><p>COVID</p></td><td class="confluenceTd"><p>2020</p></td></tr><tr><td class="confluenceTd"><p>59</p></td><td class="confluenceTd"><p>Nein</p></td><td class="confluenceTd"><p>COVID</p></td><td class="confluenceTd"><p>2020</p></td></tr><tr><td class="confluenceTd"><p>382</p></td><td class="confluenceTd"><p>Ja</p></td><td class="confluenceTd"><p>COVID</p></td><td class="confluenceTd"><p>2021</p></td></tr><tr><td class="confluenceTd"><p>373</p></td><td class="confluenceTd"><p>n.a.</p></td><td class="confluenceTd"><p>COVID</p></td><td class="confluenceTd"><p>2021</p></td></tr><tr><td class="confluenceTd"><p>77</p></td><td class="confluenceTd"><p>Nein</p></td><td class="confluenceTd"><p>COVID</p></td><td class="confluenceTd"><p>2021</p></td></tr><tr><td class="confluenceTd"><p>284</p></td><td class="confluenceTd"><p>Ja</p></td><td class="confluenceTd"><p>Pneumonie_ohne_Legionellen</p></td><td class="confluenceTd"><p>2020</p></td></tr><tr><td class="confluenceTd"><p>134</p></td><td class="confluenceTd"><p>n.a.</p></td><td class="confluenceTd"><p>Pneumonie_ohne_Legionellen</p></td><td class="confluenceTd"><p>2020</p></td></tr><tr><td class="confluenceTd"><p>42</p></td><td class="confluenceTd"><p>Nein</p></td><td class="confluenceTd"><p>Pneumonie_ohne_Legionellen</p></td><td class="confluenceTd"><p>2020</p></td></tr><tr><td class="confluenceTd"><p>262</p></td><td class="confluenceTd"><p>Ja</p></td><td class="confluenceTd"><p>Pneumonie_ohne_Legionellen</p></td><td class="confluenceTd"><p>2021</p></td></tr><tr><td class="confluenceTd"><p>120</p></td><td class="confluenceTd"><p>n.a.</p></td><td class="confluenceTd"><p>Pneumonie_ohne_Legionellen</p></td><td class="confluenceTd"><p>2021</p></td></tr><tr><td class="confluenceTd"><p>44</p></td><td class="confluenceTd"><p>Nein</p></td><td class="confluenceTd"><p>Pneumonie_ohne_Legionellen</p></td><td class="confluenceTd"><p>2021</p></td></tr></tbody></table></div><p>Which can be quickly analyzed in R with:</p><p style="margin-left: 30.0px;"><em>library(vcd)</em><br/><em>(dat &lt;- read.csv2(&quot;C:/Users/goebeln/SharePoint - USB/CDWH Team Share - Documents/CDWH Cherwell-Tickets/Archiv CDWH Tickets/20221214-3251_Consent_2Populationen_COVID_Pneumonie_sarah.draeger@usb.ch/Arbeitsbereich/2Populationen_COVID_Pneumonie.csv&quot;, header=T))</em><br/><em>(tab &lt;- xtabs(ANZ_PAT  ~ CON_VALUE+POPULATION, data=dat))</em><br/><em>mosaic(tab, shade=T, labeling = labeling_values)   </em>        </p><p>The resulting mosaic plot:           </p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/113475812/113082647.png" data-image-src="attachments/113475812/113082647.png" data-height="483" data-width="610" data-unresolved-comment-count="0" data-linked-resource-id="113082647" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20230118-161221.png" data-base-url="https://usbch.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="113475812" data-linked-resource-container-version="6" data-media-id="272c211b-25df-454b-890a-c544a795611a" data-media-type="file"></span><p>Interpretation:</p><ul><li><p>There are proportionally</p><ul><li><p>more COVID patients who were not asked for consent (n=672, 42% of all COVID)</p></li><li><p>than pneumonia patients who were not asked for consent (n=254, 29% of all pneumonia).</p></li></ul></li><li><p>The phenomenon may depend on,</p><ul><li><p>how busy departments are</p></li><li><p>how well the consent process is integrated</p></li></ul></li></ul><p>Solution:</p><ul><li><p>In case of such analyses and results, supply not only table but also plot with interpretation to ticket client.</p></li></ul>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/113475812/113082647.png">image-20230118-161221.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Okt. 26, 2023 18:02</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
